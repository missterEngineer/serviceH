{% extends "new_template/base.html" %}
{% block title %}
  Crear Usuario
{% endblock title %}
{% block style %}
    <style>
        .btn{
            color:white
        }
        form{
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            max-width: 100vw;
            padding-bottom: 20px;
            width: 500px;
            background: #002424;
            margin: 0 auto;
        }
        input{
            margin: 10px 0 20px 0;
        }
        label{
            display: block;
        }
        @media (min-width:480px) and (max-width:700px) {
            input{
            width: 40vw;
            }
            button, label{
            margin: 0
            }
        }
        #historyContent{
            display: block;
            width: 700px;
            max-width: 90vw;
            margin: 10px auto;
        }
        button{
            padding: 10px;
            background-color: blueviolet;
            border: 0;
            border-radius: 5px;
            color: white;
            font-weight: 700;
        }
        button:hover{
            cursor: pointer;
            background-color: rgb(167, 104, 226);
        }

        .msg1, .msg2{
            width: 100%;
            min-height: 45px;
            display: flex;
            align-items: center;
            padding: 10px 0px;
        }
        .msg1{
            justify-content: end;
        }
        .msg2{
            justify-content: initial;
        }
        span.msg{
            position: relative;
            border-radius: 15px;
            padding: 10px;
            max-width: 80%;
        }
        .msg1 span{
            background-color: #3f6382;
            text-align: right;
            border-bottom-right-radius: 1px;
        }
        .msg2 span{
            background-color: rgba(172, 229, 198, 0.20);
            text-align: left;
            border-bottom-left-radius: 1px;
        }
    
        span.msg::after {
            width: 0;
            position: absolute;
            display: block;
            content: '\00a0';
            bottom: 0;
            border: 8px solid transparent;
            height: 0;
        }
        .msg1 span::after{
            right: -16px;
            border-left-color: #3f6382;
        }
        .msg2 span::after{
            left: -16px;
            border-right-color: rgba(172, 229, 198, 0.20);
        }
        textarea {
            width: calc(100% - 45px);
            resize: none;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid  #B5C9C9;
            background: #001919;
            height: 90px;
            padding: 10px;
            color: black;
            font-size: 18px;
            padding-right: 35px;
            color: white;
        }
        .card-footer {
            position: relative;
        }
        .send {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            color: white;
        }
        .send:hover{
            color: rgba(255, 255, 255, 0.37);
        }
        .msg a{
            color: #00FFA1;
        }
    </style>
    <style>
        select{
            color: white;
            background-color: transparent;
            padding: 10px 5px;
            margin: 20px 0;
            width: 100px;
            border-radius: 10px;
            border: 1px solid #00CF83;
        }
        option{
            color: black;
        }
        #historyContent{
            display: none;
        }
    </style>
{% endblock style %}
{% block content %}
<a href="/hutrit/list" class="back">
    <img src="/static/images/back.svg" alt="volver">
    <span>Volver</span>
</a>
<div class="card">
    <h1 class="title">Aprende Inglés</h1>
    <form action="">
        <div class="form-control">
            <label for="name">Nivel de dificultad</label>
            <select name="level" id="level" >
                <option>A1</option>
                <option>A2</option>
                <option>B1</option>
                <option>B2</option>
                <option>C1</option>
                <option>C2</option>
            </select>
        </div>
        
        <button class="btn" type="button" onclick="init_interview()">Enviar</button>
    </form>
    <div id="historyContent" >
        <div class="msg2">
            <span class="msg">
                Inicio de la Sesión de Aprendizaje de Inglés con ChatGPT:
                <br><br>
                ¡Saludos! Mi nombre es ChatGPT y seré tu profesor virtual de inglés. Estoy programado con el propósito principal de ayudarte a aprender y mejorar tus habilidades en inglés a través de un método interactivo basado en preguntas tipo test.
                <br><br>
                A continuación, detallo el proceso que seguiremos:
                <br><br>
                Niveles de Competencia: El aprendizaje se divide en seis niveles de competencia lingüística, que van desde el A1 (principiante) hasta el C2 (maestría). Cada nivel se ha diseñado cuidadosamente para abordar vocabulario, gramática y estructuras específicas del inglés.
                <br><br>
                Formato de las Preguntas: En cada nivel, te enfrentarás a una serie de preguntas. Cada una de estas preguntas vendrá acompañada de cuatro opciones de respuesta: a, b, c y d. Tu tarea será seleccionar la respuesta que consideres correcta.
                <br><br>
                Interacción y Retroalimentación: solo me felicitaras si la respuesta es correcta . Si respuesta no es la correcta, explicaras el por qué y mostraras la respuesta adecuada, asegurando así un aprendizaje efectivo. cada vez que una pregunta sea contestada procederás a dar la siguiente pregunta
                <br><br>
                Progresión y Evaluación: Al concluir las 10 preguntas de un nivel, recibirás una felicitación por haber terminado el nivel y una puntuación de 1 al 10 sobre las respuestas acertadas . Luego, te ofreceré la opción de avanzar al siguiente nivel con la opción a que sera un si o finalizar la sesión que sera la opción b. Si eliges avanzar, la dinámica será la misma, pero con un nivel de complejidad mayor.
                <br><br>
                Ventajas de este Método:
                <br><br>
                Retroalimentación Inmediata: Te permite corregir y aprender de tus errores en tiempo real.
                Aprendizaje Modular: Puedes aprender y evaluar tu conocimiento nivel por nivel.
                Flexibilidad: Puedes decidir el ritmo y cuándo avanzar.
                Con toda esta información en mente, ¿estás listo para embarcarte en esta aventura lingüística? Si es así, por favor, especifica el nivel con el que deseas iniciar (A1, A2, B1, B2, C1, C2) y comenzaremos con la primera pregunta. ¡Espero que disfrutes este viaje hacia el dominio del inglés!
            </span>
        </div>
    </div>
    <div class="card-footer" hidden>
        <textarea id="questionGPT" hidden></textarea>
        <a class="send" href="#" id="sendGPT" onclick="answerGPT()" hidden>
            <svg width="25" height="24" viewBox="0 0 25 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="gpt-send">
                <mask id="mask0_38_875" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="25"
                    height="24">
                    <rect x="0.984375" width="24" height="24" fill="currentColor" />
                </mask>
                <g mask="url(#mask0_38_875)">
                    <path
                        d="M3.48437 4.5L4.48438 3.5L22.4844 11.5L4.48437 19.5L3.48437 18.5L6.48437 11.5L3.48437 4.5ZM6.58437 6.6L8.68437 11.5L6.58437 16.4L17.5844 11.5L6.58437 6.6Z"
                        fill="currentColor" />
                </g>
            </svg>
        </a>
    </div>
</div>
{% endblock content %}
{% block script %}
<script src="/static/js/socket.io.js"></script>
<script src="/static/js/socket.config.js"></script>

<script>
    const historyContent = document.getElementById("historyContent");
    /** @type {HTMLElement} */
    let current_msg; 

    function init_interview(){
        const form = document.forms[0];
        const body = new FormData(form);
        add_loader();
        const data = Object.fromEntries(body.entries());
        createMsg("1", data.level);
        current_msg = createMsg(2);
        document.querySelector(".card-footer").hidden = false;
        form.style.display = "none"
        socket.emit("start_english", data);
        document.getElementById("historyContent").style.display = "block"
    }

    function add_loader(){
        const p = document.createElement("p");
        p.id = "generando";;
        p.textContent = "Generando...";
        historyContent.appendChild(p);
    }

    function answerGPT(){
        const textarea = document.querySelector("textarea")
        let msg = textarea.value;
        createMsg("1", msg);
        scroll2Bottom();
        current_msg = createMsg(2);
        add_loader();
        socket.emit("answer_interview", msg)
        setTimeout(()=> textarea.value = "", 100)
    }
    
    socket.on('chatResponse', msg => {
        current_msg.innerText += msg;
        scroll2Bottom();
    })

    socket.on('chatEnd', () => {
        document.getElementById("generando").remove();
        convert2hyperlink();
    })


    function convert2hyperlink(){
        let textList = current_msg.innerText.split("\n");
        let loop_times = 0;
        let pass_number = false;
        for(let f=0; f < textList.length; f++){
            console.log(textList[f])
            if(has_number(textList[f])  && !pass_number){
                pass_number =  true;
                console.log("1st conditional")
                continue
            }
            if(!pass_number) {
                console.log("2nd conditional")
                continue
            }
            if(is_item_list(textList[f], loop_times)){
                if(loop_times < 4){
                    loop_times++;
                }else{
                    break
                }
                textList[f] = "<a href='#' onclick='choose(this)'>" + textList[f] + "</a><br>";
            }
        }
        current_msg.innerHTML = textList.join('<br>');
    }

    /** @param {HTMLAnchorElement} anchor */
    function choose(anchor){
        document.getElementById("questionGPT").value = anchor.innerText;
        current_msg.querySelectorAll("a").forEach(inner_anchor=>{
            inner_anchor.removeAttribute("href");
            inner_anchor.onclick = void(0);
        })
        answerGPT();
    }

    function has_number(str){
        return /\d/.test(str)
    }

    /** @param {string} text */
    function is_item_list(text, loop_time){
        console.log(loop_time)
        if(text.toLowerCase().includes("a, b, c")) return false;
        if(text.toLowerCase().includes("a)") && loop_time === 0)  return true;
        if(text.toLowerCase().includes("b)") && loop_time === 1) return true;
        if(text.toLowerCase().includes("c)") && loop_time === 2) return true;
        if(text.toLowerCase().includes("d)") && loop_time === 3) return true;
        return false;
    }


    function createMsg(msg_num, msg=""){
        const div = document.createElement("div");
        div.classList.add(`msg${msg_num}`);
        const span = document.createElement("span");
        span.classList.add("msg");
        span.innerText = msg;
        div.appendChild(span);
        historyContent.appendChild(div);
        return span
    }


    function scroll2Bottom(){
        if(document.body.scrollTop !== document.body.scrollHeight){
            document.body.scrollTop = document.body.scrollHeight
        }
    }

</script>

{% endblock script %}