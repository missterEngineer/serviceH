{% extends "new_template/base.html" %}
{% block title %}
Inicio
{% endblock title %}
{% block style %}
<style>
    .btn {
        color: white;
        display: inline-flex;
        align-items: center;
        margin: 0 10px;
        font-size: 16px;
        text-decoration: none;
    }

    .btn img {
        margin: 0 10px
    }

    .btn-box {
        text-align: center;
    }

    .audio-item {
        position: relative;
        border-radius: 8px;
        background: rgba(0, 28, 28, 0.50);
        margin: 5px 0;
        padding: 5px 10px;
        display: grid;
        gap: 10px;
        grid-template-columns: 25px 1fr 25px 25px;
    }

    .card {
        overflow-y: auto;
        padding: 16px;
        height: 400px;
        position: relative;
    }

    .audio-txt {
        width: auto;
        padding: 0;
        text-decoration: none;
    }

    .audio-txt:hover {
        cursor: pointer;
    }

    .audio-name {
        color: rgba(255, 255, 255, 0.75);
        text-overflow: ellipsis;
        font-size: 20px;
        margin: 0;
        text-align: left;
    }

    .audio-date {
        color: rgba(255, 255, 255, 0.40);
        font-size: 12px;
        margin: 0;
        text-align: left;
    }

    .ico-link {
        height: 25px;
    }

    .empty p {
        color: rgba(255, 255, 255, 0.75);
        text-align: center;
        font-size: 14px;
    }

    .empty {
        width: 300px;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        position: absolute;
    }

    #drop_zone {
        border: 1px dashed #ACE5C6;
        background: rgba(172, 229, 198, 0.20);
        width: 355px;
        text-align: center;
        padding: 16px;
        margin: 0 auto 20px auto;
        border-radius: 8px;
        position: relative;
    }
    #drop_zone.error{
        border-color: "#D34D4D";
    }

    .backup-lg {
        width: 48px;
        height: 48px;
    }

    .drop-formats {
        color: #B5C9C9;
        font-size: 14px;
        margin: 5px 0 0 0;
    }

    .drop-txt {
        color: #FAFAFA;
        font-size: 18px;
        margin: 5px 0 0 0;
    }

    .drop-a {
        color: #00CF83
    }

    .drop-title {
        font-size: 24px;
        color: #FAFAFA;
    }

    dialog {
        background: #001C1C;
    }

    dialog .btn {
        color: #ACE5C6;
    }

    .drop-info-txt {
        font-size: 14px;
    }

    .dropping {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 1;
        background-color: #001c1cd7;
        display: none;
    }

    .dropping p {
        margin: auto 0;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 26px;
    }
    #text-drop{
        font-size: 12px;
    }
    progress{
        height: 3px;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        border: none;
        background-color: transparent;
        z-index: 1;
        transform: translateY(50%);
    }
    .your-file{
        position: relative;
        width: 340px;
        background-color: #004949;
        border-radius: 4px;
        border: 0.5px solid #B5C9C9;
        font-size: 12px;
        height: 26px;
        padding: 10px 10px 0 10px;
        text-align: left;
        margin: 0 auto 10px auto;
        display: none;
    }
    progress::-webkit-progress-value {
        background-color: #00CF83;
      }
      
    progress::-moz-progress-bar {
        background-color: #00CF83;
    }
    progress::-webkit-progress-bar {
        background-color: transparent;
    }
    .drop-audio-upload{
        width: 350px;
        position: relative;
        padding: 15px 10px;
        border-radius: 4px;
        border: 1px solid #00CF83;
        background: #004949; 
        text-align: left;
        margin: 0 auto;
    }
    .drop-audio-upload .trash{
        position: absolute;
        right: 5px;
        top:50%;
        transform: translateY(-50%);
    }
    .drop-audio-upload .trash img{
        width: 20px;
    }
    .drop-audio-upload .audio{
        margin-right: 5px;
    }
    #btn-repeat{
        display: none;
    }
    .btn-box .btn{
        width: 145px;
        margin: 10px;
    }

    .circle{
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: block;
        position: relative;
        margin: 0 auto;
    }
    .circle svg{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .warning{
        background-color: #FFEEB2;
    }
</style>
<style>
    .filename{
        width: 100%;
        background: transparent;
        border:#004949;
        color: white;
        font-size: 18px;
    }
    .filename:focus-visible{
        outline: none;
        border-bottom: double 3px #17af7767;
    }
    .focus{
        border: 1px solid #00CF83;
    }
</style>
{% endblock style %}
{% block content %}
<div class="btn-box">
    <a class="btn" href="/recorder">
        <img src="/static/images/micro.svg" alt="micrófono">
        Grabar audio
    </a>
    <a class="btn" href="#" onclick="open_modal()">
        <img src="/static/images/cloud.svg" alt="">
        Subir audio
    </a>
</div>
<div class="card">
    {% if audios %}
    {% for audio in audios %}
    <div class="audio-item" id="audio-{{loop.index}}">
        <img src="/static/images/msg.svg">
        <a href="/player/{{audio.name}}" class="audio-txt">
            <p class="audio-name">{{audio.name.replace("_"," ")}}</p>
            <p class="audio-date">{{audio.date}}</p>
        </a>
        <a href="#" class="ico-link" onclick="edit_audio_name(this)" data-name="{{audio.name}}" data-index="{{loop.index}}" >
            <img src="/static/images/edit.svg" alt="editar" >
        </a>
        <a href="#" class="ico-link" onclick="confirm_delete(`{{audio.name}}`, `{{loop.index}}`)">
            <img src="/static/images/delete.svg" alt="eliminar">
        </a>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty">
        <img src="/static/images/find.svg" alt="buscar">
        <p>Aquí verás tu historial de grabaciones. podrás revisar, vuelve a editar o eliminar sesiones</p>
    </div>
    {% endif %}

</div>
{% endblock content %}

{% block modal %}
<dialog>
    <img src="/static/images/backup_circle.svg" alt="">
    <h3 class="drop-title">Subir audio</h3>
    <div id="drop_zone">
        <img src="/static/images/backup.svg" class="backup-lg" alt="">
        <p class="drop-txt"><a href="#" class="drop-a">Sube</a> o arrastra tú audio</p>
        <p class="drop-formats">Formatos aceptados: mp3, wav, m4a, ACC </p>
        <input type="file" name="audio" hidden>
    </div>
    <style>
        
    </style>
    <div class="drop-audio-upload" hidden>
        <img class="audio" src="/static/images/micro.svg" alt="audio"><span></span>
        <a href="#" class="trash"><img src="/static/images/trash.svg" alt="eliminar"></a>
    </div>
    <div class="dropping">
        <p>Suelta el archivo aquí</p>
    </div>
    <!-- <p class="drop-info-txt">Tamaño máximo de archivo: 100mb</p>  -->
    
    <div class="your-file"><span id="filename"></span><progress max="100" value="0"></progress></div>
    <p class="drop-formats" id="text-drop"></p>
    <button type="button" class="btn" onclick="close_modal()" id="btn-cancel">Cancelar</button>
    <button type="button" class="btn" onclick="show_dropzone()" id="btn-repeat" hidden>Subir otro</button>
    <button type="button" class="btn success disabled" id="btn-go-audio">Ir al audio</button>
</dialog>
<dialog id="dialog-delete">
    <span class="circle warning">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <mask id="mask0_251_1719" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="32" height="32">
            <rect width="32" height="32" fill="#D9D9D9"/>
            </mask>
            <g mask="url(#mask0_251_1719)">
            <path d="M16 29.3666C15.6444 29.3666 15.3055 29.3 14.9833 29.1666C14.6611 29.0333 14.3666 28.8444 14.1 28.6L3.39997 17.9C3.15552 17.6333 2.96663 17.3389 2.8333 17.0166C2.69997 16.6944 2.6333 16.3555 2.6333 16C2.6333 15.6444 2.69997 15.3 2.8333 14.9666C2.96663 14.6333 3.15552 14.3444 3.39997 14.1L14.1 3.39997C14.3666 3.1333 14.6611 2.93886 14.9833 2.81663C15.3055 2.69441 15.6444 2.6333 16 2.6333C16.3555 2.6333 16.7 2.69441 17.0333 2.81663C17.3666 2.93886 17.6555 3.1333 17.9 3.39997L28.6 14.1C28.8666 14.3444 29.0611 14.6333 29.1833 14.9666C29.3055 15.3 29.3666 15.6444 29.3666 16C29.3666 16.3555 29.3055 16.6944 29.1833 17.0166C29.0611 17.3389 28.8666 17.6333 28.6 17.9L17.9 28.6C17.6555 28.8444 17.3666 29.0333 17.0333 29.1666C16.7 29.3 16.3555 29.3666 16 29.3666ZM16 26.7L26.7 16L16 5.29997L5.29997 16L16 26.7ZM14.6666 17.3333H17.3333V9.3333H14.6666V17.3333ZM16 21.3333C16.3777 21.3333 16.6944 21.2055 16.95 20.95C17.2055 20.6944 17.3333 20.3777 17.3333 20C17.3333 19.6222 17.2055 19.3055 16.95 19.05C16.6944 18.7944 16.3777 18.6666 16 18.6666C15.6222 18.6666 15.3055 18.7944 15.05 19.05C14.7944 19.3055 14.6666 19.6222 14.6666 20C14.6666 20.3777 14.7944 20.6944 15.05 20.95C15.3055 21.2055 15.6222 21.3333 16 21.3333Z" fill="#6B4426"/>
            </g>
        </svg> 
    </span>
    <h2>¿Deseas eliminar tu audio?</h2>
    <p>Si lo haces, no podrás recuperar tu grabación</p>
    <button class="btn" id="delete_btn">Sí, eliminar</button>
    <button class="btn success" id="exit_delete_btn" >No, mantener audio</button>
</dialog>
{% endblock modal %}

{% block script %}
<script>
    const btnCancel = document.getElementById("btn-cancel"),
        btnGoAudio = document.getElementById("btn-go-audio"),
        btnRepeat = document.getElementById("btn-repeat"),
        dialog = document.querySelector("dialog"),
        dropping = document.querySelector(".dropping"),
        dropzone = document.getElementById("drop_zone"),
        progressBar = document.querySelector("progress"),
        your_file = document.querySelector(".your-file");
    let filename = "",
        dragCont1 = 0,
        dragCont2 = 0;

    const open_modal = () => dialog.showModal();
    const close_modal = () => dialog.close();
    document.getElementById("exit_delete_btn").onclick = cancel_delete


    function confirm_delete(audio, index){
        document.getElementById("dialog-delete").showModal();
        document.getElementById("delete_btn").onclick = () => del_file(audio, index);

    }

    function cancel_delete(){
        document.getElementById("dialog-delete").close();
    }


    function del_file(audio, index) {
        cancel_delete();
        fetch(`/del_file?filename=${audio}`).then(data => data.json()).then(() => {
            document.getElementById('audio-' + index).remove();
            toast("Audio eliminado con éxito", "var(--success)");
        }).catch(() => {
            toast("No existe el archivo", "var(--error)");
        })
    }

    /** @param {HTMLAnchorElement} hyperlink */
    function edit_audio_name(hyperlink){
        const edit_img =  hyperlink.firstElementChild;
        edit_img.src = "/static/images/save_bold.svg";
        const del_hyper = hyperlink.nextElementSibling;
        del_hyper.hidden = true;
        hyperlink.onclick = () => save_audio_name(hyperlink);
        const main_anchor = hyperlink.previousElementSibling;
        main_anchor.firstElementChild.hidden = true;
        main_anchor.removeAttribute("href");
        const input = document.createElement("input");
        input.type = "text";
        input.classList.add("filename");
        input.value = hyperlink.dataset.name;
        main_anchor.insertAdjacentElement('afterbegin', input);
        main_anchor.parentElement.classList.add("focus")
        input.focus();
    }


    /** @param {HTMLAnchorElement} hyperlink */
    async function save_audio_name(hyperlink){
        const main_anchor = hyperlink.previousElementSibling;
        const value =  main_anchor.firstElementChild.value;
        const old_value = hyperlink.dataset.name;
        if (!await update_audio(old_value, value)){
            return
        }
        const edit_img =  hyperlink.firstElementChild;
        edit_img.src = "/static/images/edit.svg";
        const del_hyper = hyperlink.nextElementSibling;
        del_hyper.hidden = false;
        hyperlink.onclick = () => edit_audio_name(hyperlink);
        main_anchor.firstElementChild.remove();
        main_anchor.firstElementChild.innerText = value;
        main_anchor.firstElementChild.hidden = false;
        main_anchor.setAttribute("href", `/player/${new_value}`);
        main_anchor.parentElement.classList.remove("focus")
    }


    /**
    @param {string} old_value
    @param {string} new_value
    */
    async function update_audio(old_value, new_value){
        const data = new FormData();
        data.append("old", old_value);
        data.append("new", new_value);
        const response = await fetch("update_audio_name",{
            body:data,
            method:"POST"
        });
        const result = await response.json();
        let color, success;
        if (result.status === 200) {
            color = "var(--success)";
            success = true
        }else{
            color = "var(--error)";
            success = false
        }
        toast(result['message'], color);
        return success
    }
    
    
    function show_dropzone(){
        btnGoAudio.classList.add("disabled");
        btnCancel.style.display = "inline-flex";
        btnRepeat.style.display = "none";
        dropzone.hidden = false;
        document.querySelector("div.drop-audio-upload").hidden = true;
    }

    
    /* DROPZONE */
    function dropHandler(ev) {
        ev.preventDefault();
        let file
        if (ev.dataTransfer.items) {
            const item = ev.dataTransfer.items[0];
            if (item.kind === "file") {
                file = item.getAsFile();
            }
        } else {
            file = ev.dataTransfer.files[0]
        }
        uploadFile(file);
    }


    function dragOverHandler(ev) {
        ev.preventDefault();
        if (dropping.style.display !== "block") {
            dropping.style.display = "block"
        }
        dragCont1++
    }


    setInterval(() => {
        if (dragCont1 === dragCont2) {
            if (dropping.style.display === "block") {
                dropping.style.display = "none";
                dragCont1 = 0;
                dragCont2 = 0;
            }
        } else {
            dragCont1 = dragCont2
        }
    }, 100)


    dialog.addEventListener("drop", dropHandler)
    dialog.addEventListener("dragover", dragOverHandler)

    /* FILE BUTTON */
    const input_file = document.querySelector('input[type="file"]'),
        text_element = document.getElementById("text-drop");

    document.querySelector(".drop-a").onclick = () => {
        input_file.click()
    }

    input_file.addEventListener("change", () => uploadFile(input_file.files[0]))

   /* AJAX */
    function uploadFile(file){
        if (!checkFile(file)) {
            text_element.innerText = "El archivo subido está en un formato no aceptado, intenta nuevamente";
            text_element.style.color =  "#D34D4D"; 
            dropzone.classList.add("error")
            return
        }
        btnGoAudio.onclick = () => void(0) ;
        text_element.innerText = ""
        dropzone.classList.remove("error");
        dropzone.hidden = true;
        const data = new FormData();
        data.append('audio', file);
        filename = file.name;
        let new_filename = filename;
        if(filename.length > 40){
            new_filename = filename.substring(0,40) + "..."
        }
        document.getElementById("filename").innerText = new_filename;
        document.querySelector("div.drop-audio-upload").innerText = new_filename;
        your_file.style.display = "block";
        progressBar.value = "0";
        const ajax = new XMLHttpRequest();
        ajax.upload.addEventListener("progress", progressHandler, false);
        ajax.addEventListener("loadend", completeHandler, false);
        ajax.addEventListener("error", errorHandler, false);
        ajax.addEventListener("abort", errorHandler, false);
        ajax.open("POST", "/upload_file");
        ajax.send(data);
    }

    function checkFile(file) {
        const audio_formats = ['MP3', 'WAV', 'AAC', 'FLAC', 'OGG', 'WMA', 'ALAC', 'AIFF', 'M4A', 'AC3'];
        let ext = file.name.split('.');
        ext = ext[ext.length - 1];
        return audio_formats.includes(ext.toUpperCase())
    }

    function progressHandler(event) {
        const percent = (event.loaded / event.total) * 100;
        progressBar.value = Math.round(percent)
    }

    function completeHandler(event) {
        try {
            const response = JSON.parse(event.target.response)
            if ('success' in response) {
                your_file.style.display = "none";
                const div_audio = document.querySelector("div.drop-audio-upload");
                div_audio.querySelector("span")
                div_audio.hidden = false;
                btnCancel.style.display = "none";
                btnRepeat.style.display = "inline-flex";
                btnGoAudio.classList.remove("disabled");
                btnGoAudio.onclick = () => location.href = `/player/${filename}`
            }
        } catch (error) {
            save_error("upload_file", error.message)
            console.error(error)
            errorHandler(event)
        }
    }

    function errorHandler(event) {
        text_element.style.color = "#D34D4D"
        text_element.innerHTML = "Ocurrió un error subiendo el documento, intenta nuevamente";
        dropzone.hidden = false
        console.log(event)
        save_error("upload_file", event.target.statusText)
    }
</script>
{% endblock script %}